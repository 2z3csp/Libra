# 購入仕様書システム 設計書（共同作業用）

## 0. この設計書の目的

* **目的**：要件・定義・動作・判断履歴を一箇所に集約し、実装を安定させる（手戻りと不整合を減らす）。
* **運用方針**：この設計書を「正（Single Source of Truth）」として、実装・JSON/設定ファイル等の整合を取る。

---

## 1. スコープ

### 1.1 対象（In Scope）

* デスクトップアプリ（PySide6）によるフォルダ登録とドキュメントのバージョン管理。
* OneDrive などの同期フォルダを想定したファイル更新・差し替え・差し戻し。
* ローカル環境（AppData 配下）の設定・登録情報の管理。

### 1.2 対象外（Out of Scope）

* クラウド API との連携やサーバーサイド機能。
* 外部データベースや認証基盤の導入。
* Web アプリケーション化。

---

## 2. 用語集（Glossary）

| 用語 | 意味 | 備考 |
| --- | --- | --- |
| Registry | 登録フォルダ一覧を保持する設定ファイル | `registry.json` |
| Settings | UI 状態などの設定ファイル | `settings.json` |
| Meta | 登録フォルダ直下に保存されるメタデータ | `.libra_meta.json` |
| History | 過去バージョンを格納するフォルダ | `_History` |
| Doc Key | ドキュメントを識別するキー（拡張子込みのベース名） | 例: `sample.docx` |

---

## 3. 要件（Must / Should / Could / Won’t）

### 3.1 機能要件

| ID | 要件 | 区分 | 受入条件（Acceptance Criteria） | 備考 |
| --- | --- | --- | --- | --- |
| FR-001 | フォルダを登録できる | Must | 登録後にカテゴリツリーと一覧に表示される | `registry.json` に保存される |
| FR-002 | 登録フォルダ内の最新ファイルを一覧表示する | Must | `.libra_meta.json` と実ファイルの差分を補正し表示できる | スキャン時にメタ更新 |
| FR-003 | 更新（Update）で新しいリビジョンを作成する | Must | 新ファイル作成 + 旧ファイルが `_History` に移動し履歴に追記される | バージョン選択あり |
| FR-004 | 差し替え（Replace）で外部ファイルを最新化する | Must | 外部ファイルが新リビジョン名で配置され、履歴が追記される | パッチ自動加算 |
| FR-005 | 差し戻し（Rollback）で過去履歴から復元する | Must | 選択履歴が最新化され、旧現行は `_History` に退避される | メモに差し戻し表示 |
| FR-006 | 履歴削除を実施できる | Should | 選択履歴ファイルが削除され、メタから除外される |  | 

### 3.2 非機能要件（性能・運用・保守）

| ID | 要件 | 区分 | 受入条件 | 備考 |
| --- | --- | --- | --- | --- |
| NFR-001 | Windows で隠しファイル属性を設定できる | Must | `.libra_meta.json` が隠し属性になる | `set_hidden_on_windows()` | 
| NFR-002 | ローカルファイルのみで動作する | Must | 外部サービス依存がない |  | 

---

## 4. ユースケース

### 4.1 ユースケース一覧

| UC | タイトル | 主アクター | 成果物 |
| --- | --- | --- | --- |
| UC-01 | フォルダ登録 | ユーザー | `registry.json` の更新、UI 反映 |
| UC-02 | ファイル更新 | ユーザー | 新リビジョンファイル、履歴更新 |
| UC-03 | ファイル差し替え | ユーザー | 外部ファイルの最新版化 |
| UC-04 | 差し戻し | ユーザー | 履歴ファイルの最新化 |

### 4.2 主要フロー（例：UC-02 ファイル更新）

1. 対象フォルダと最新ファイルを選択する。
2. 更新ダイアログで次バージョンを選択する。
3. 現行ファイルを複製し新リビジョンを作成する。
4. 旧現行ファイルを `_History` へ移動する。
5. `.libra_meta.json` の履歴と更新者情報を更新する。

### 4.3 例外・エラー処理

* 現行ファイルが見つからない場合は警告を表示し処理を中断する。
* 新規ファイル名が既に存在する場合は警告を表示し処理を中断する。

---

## 5. データ定義（正の定義：SSOT）

> ここが最重要。JSONキー、UI表示名の**対応を固定**し、実装はここに従う。

### 5.1 フィールド定義

| フィールドキー | 表示名 | 型 | 必須 | 既定値 | 由来（Excel/JSON/入力） | 変換/検証ルール | 備考 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| name | 登録名 | string | Yes |  | ユーザー入力 | 空文字不可 | registry.json |
| path | フォルダパス | string | Yes |  | ユーザー入力 | 実在フォルダ | registry.json |
| categories | カテゴリ階層 | array[string] | Yes |  | ユーザー入力 | 空要素は除外 | registry.json |
| current_file | 最新ファイル | string | Yes |  | ファイルスキャン | 実在ファイル | .libra_meta.json |
| current_rev | 最新リビジョン | string | Yes |  | ファイル名 | `revA.B.C_YYYYMMDD` | .libra_meta.json |
| updated_at | 更新日時 | string | No |  | 更新処理 | ISO 形式 | .libra_meta.json |
| updated_by | 更新者 | string | No |  | OS ログインユーザー |  | .libra_meta.json |
| last_memo | 最終メモ | string | No |  | ダイアログ入力 |  | .libra_meta.json |

### 5.2 Excelテンプレ仕様

* 対象ファイル：なし
* シート構成：なし
* Named range：なし
* 入出力セル：なし

### 5.3 JSON/設定ファイル仕様

* ファイル名：`registry.json`
  * 保存先：AppData 配下 `Libra/config/registry.json`
  * 形式：配列（登録フォルダの一覧）
* ファイル名：`settings.json`
  * 保存先：AppData 配下 `Libra/config/settings.json`
  * 形式：辞書（UI 状態/カテゴリ順序/無視拡張子）
* ファイル名：`user_checks.json`
  * 保存先：AppData 配下 `Libra/cache/user_checks.json`
  * 形式：辞書（チェック状態キャッシュ）
* ファイル名：`.libra_meta.json`
  * 保存先：登録フォルダ直下
  * 形式：`{ "documents": { ... } }` の辞書

---

## 6. 画面仕様（UI）

### 6.1 画面一覧

| 画面ID | 名称 | 目的 | 入力 | 出力 |
| --- | --- | --- | --- | --- |
| UI-01 | メイン画面 | 登録フォルダ・最新ファイル・履歴の操作 | クリック/ドラッグ/ダイアログ入力 | ファイル操作/メタ更新 |
| UI-02 | 登録ダイアログ | フォルダ登録 | フォルダパス、登録名、カテゴリ | registry.json 更新 |
| UI-03 | 更新ダイアログ | 次バージョン選択 | メジャー/マイナー/パッチ選択、提出ファイル生成チェック、メモ | 新リビジョン名 |
| UI-04 | 差し替えダイアログ | 外部ファイル選択 | 取り込みファイル、メモ | 新リビジョン生成 |
| UI-05 | 履歴選択/削除ダイアログ | 履歴選択/削除 | 履歴アイテム | 履歴更新 | 
| UI-06 | 履歴詳細ダイアログ | 履歴の詳細表示とメモ編集 | メモ編集 | メモ更新 |

### 6.2 画面詳細（例：UI-01）

* レイアウト：左にカテゴリ/フォルダ一覧、中央に最新ファイル一覧、右/下に履歴一覧。
* 操作：追加/更新/差し替え/差し戻し/履歴操作をボタンで実行。
* 操作補足：フォルダリストに「フォルダ出力」ボタンを追加し、選択中の登録フォルダをメタ/History除外で出力する。
* 操作補足：フォルダリストのコンテキストメニューに「フォルダ確認」を追加し、新規フォルダ検知による背景色を解除する。
* 操作補足：更新ダイアログの「提出ファイル生成」チェック時は新規生成後に自動でファイルを開かない。
* 操作補足：履歴詳細ダイアログのメモは編集可能で、閉じる時に保存確認を行う。
* 操作補足：メモ入力タイムアウトで「後で」を選択すると、再度タイマーを開始する。
* 操作補足：メモ入力の監視はファイル単位で並行管理し、複数ファイルを更新しても各ファイルの編集終了時に個別にポップアップ表示する。
* 操作補足：ツールバーに「不具合報告情報をコピー」を配置し、バージョン/OS/AppData各パスをクリップボードへ出力できる。
* 操作補足：Office以外などロック検知できないアプリでも、更新後のファイル更新時刻（mtime）変化と無操作時間を基準に「作業終了時」相当でメモ入力を表示する。
* 表示順：ファイルリストは名称順で表示する。
* バリデーション：対象ファイル未選択時は警告ダイアログを表示。
* エラーメッセージ：ファイル未存在、重複名などを警告表示。

---

## 7. アーキテクチャ（最小限の構造定義）

### 7.1 コンポーネント

| コンポーネント | 責務 | 入力 | 出力 |
| --- | --- | --- | --- |
| MainWindow | 画面表示と操作制御 | ユーザー操作 | ファイル操作/メタ更新 |
| RegistryStore | 登録フォルダの保存/読み込み | registry.json | 登録一覧 |
| SettingsStore | 設定保存/読み込み | settings.json | UI 設定 |
| MetaStore | メタデータ保存/読み込み | .libra_meta.json | ドキュメント状態 |
| FileOps | 更新/差し替え/差し戻し | ファイルパス | 新規ファイル/履歴更新 |

### 7.2 データフロー（文章でOK）

* 起動時に registry と settings を読み込み、カテゴリ/フォルダを表示する。
* フォルダ選択時にメタを読み込み、最新ファイル一覧と履歴を更新する。
* 更新/差し替え/差し戻し時はファイル操作後にメタを書き戻す。

### 7.3 ディレクトリ構成ポリシー

* 実行エントリポイントは `src/libra/app.py` を正とし、リポジトリ直下の `Libra.py` は開発用ランチャーとして `libra.app.main()` を呼び出すだけの薄い構成とする。
* 配布時に同梱するリソース（アイコン・画像）は `src/libra/resources/` 配下に配置し、アプリ本体はパッケージ相対パスで参照する。
* `src/libra/main.py` は後方互換のための互換モジュールとし、新規実装・新規importは `libra.app` を使用する。
* `core/` と `ui/` を新設・移設する場合は必ず `src/libra/` 配下に配置し、ルート直下には置かない（配布時の追跡漏れ防止）。
* PyInstaller ビルドは `scripts/build_pyinstaller.py` を使用し、エントリポイントを `src/libra/app.py` に固定する。
* `src/libra/__init__.py` に `__version__` を定義し、`src/libra/app.py` 起動時にウィンドウタイトルと起動ログ（バージョン/AppData出力先）へ表示する。
* AppData 配下の保存先は `src/libra/core/paths.py` で一元管理し、`config`/`logs`/`cache` の各ディレクトリを用途別に分離する。
* リソース参照は `resource_path()` を経由し、通常起動・PyInstaller 起動（`sys._MEIPASS`）の双方で同一コードを使用する。
* `scripts/build_pyinstaller.py` はビルド時に `git describe --tags --dirty --always` を優先してバージョンを決定し、失敗時は日付+short SHAへフォールバックする。さらに `dist/Libra/VERSION.txt` を生成し、配布zipは `Libra-<version>/Libra/...` 構成で作成する。
* バージョン運用は「プロダクト版（`MAJOR.MINOR.PATCH`）とビルド識別子（`git describe`）」の2層で管理し、ユーザー向け説明は前者、障害解析は後者を使用する。
* 正式配布はタグ（`vX.Y.Z`）付きコミットを原則とし、タグなし配布は検証版として扱う。
* 配布アプリは `VERSION.txt` を最優先で表示し、未配置時のみ `src/libra/__init__.py` の `__version__` を表示する。
* PyInstaller の実行入口は `src/pyinstaller_entry.py`（`from libra.app import main`）とし、onefile/onedir でのトップレベル実行時も相対import失敗を回避する。
* 配布zip名はプロダクト版（`src/libra/__init__.py` の `__version__`）を採用し、`VERSION.txt` には `プロダクト版+ビルド識別子` を保存して利用者表示と障害解析を両立する。

---

## 8. 例外設計（失敗時にどうするか）

| 事象 | 検知タイミング | 表示/ログ | リカバリ手順 |
| --- | --- | --- | --- |
| 現行ファイルが不存在 | 更新/差し替え/差し戻し開始時 | 警告ダイアログ | 対象フォルダ/ファイルを再選択 |
| 新規ファイル名が重複 | 更新/差し替え/差し戻しの作成前 | 警告ダイアログ | 再実行でバージョンを進める |
| メタデータ読込失敗 | フォルダスキャン時 | 既定値で処理 | `.libra_meta.json` を再生成 |

---

## 9. 品質保証（テスト/チェック）

### 9.1 チェックリスト

* [ ] フィールド定義と実装の一致
* [ ] registry/settings/meta の構造が設計書と一致
* [ ] 主要ユースケースの動作確認

### 9.2 受入テスト項目

| ID | 観点 | 手順 | 期待結果 |
| --- | --- | --- | --- |
| AT-001 | 登録フロー | 登録→一覧反映 | 一覧に表示される |
| AT-002 | 更新フロー | 更新→履歴確認 | 最新/履歴が更新される |
| AT-003 | 差し替えフロー | 差し替え→履歴確認 | 最新/履歴が更新される |

---

## 10. 変更履歴（ADR：判断ログ）

| 日付 | 決定事項 | 理由 | 影響範囲 |
| --- | --- | --- | --- |
| 2025-02-14 | 設計書フォーマットを共通テンプレートに統一 | 共同作業用の統一フォーマットが必要 | 全体 |
| 2025-02-19 | 更新ダイアログの提出チェックとメモ入力、フォルダ出力、履歴メモ編集、ファイル名順表示を追加 | 運用要件をUI/動作に反映 | UI/履歴/ファイル一覧 |
| 2025-02-19 | メモ入力タイムアウトの「後で」でタイマーを再開する | 手動移行ではなく再通知する運用に合わせる | メモ入力 |
| 2026-01-27 | フォルダリストの「フォルダ確認」で新規検知ハイライトを解除できるようにする | 新規検知の確認操作を明確化するため | フォルダリスト/カテゴリツリー |
| 2026-02-10 | パッケージに `__version__` を追加し、`app.py` を唯一の実行入口としてランチャーを薄く統一 | 配布時の入口統一と不具合報告時の識別（バージョン/ログ出力先）を容易にするため | エントリポイント/起動ログ |
| 2026-02-10 | AppData パス管理を `core/paths.py` に集約し、`VERSION.txt` 優先のバージョン表示と不具合報告情報コピーを追加 | PyInstaller/通常起動でのパス差異と報告情報不足を減らし、配布版の識別とサポート効率を上げるため | パス管理/バージョン表示/UIサポート |
| 2026-02-10 | build 版識別を `git describe --dirty --always` 優先へ強化し、配布zipのトップ階層を `Libra-<version>` へ統一 | タグ未一致/dirty状態でも配布物とコミット対応を追跡しやすくし、展開後の版識別を明確化するため | ビルド運用/配布物構造 |
| 2026-02-10 | バージョン管理方針を2層（プロダクト版/ビルド識別子）へ整理し、タグ運用を正式配布の基準として明文化 | 利用者向け説明の分かりやすさと、障害調査時の追跡性を両立するため | リリース運用/障害解析 |
| 2026-02-10 | `.libra_meta.json` の保存で権限エラーが発生しても処理全体を停止させず、警告ログ出力で継続する | 読取専用フォルダや同期競合時でもUIの再スキャン処理を継続し、連続例外で操作不能になることを防ぐため | メタ保存/再スキャン |
| 2026-02-10 | `.libra_meta.json` 保存失敗警告は同一パスで初回のみ表示し、重複ログを抑止する | 起動時・再スキャン時に同一エラーが多重出力されると運用時の判読性が下がるため | メタ保存/ログ出力 |
| 2026-02-10 | 作業メモ監視を単一ファイル管理から複数ファイル並行管理へ変更し、ロック不可アプリでは更新時刻とアイドル時間で終了検知する | 複数更新時に最後の1件しかメモ入力されない課題と、アプリ差によるメモ表示タイミング差を解消するため | メモ入力/監視タイマー |
| 2026-02-10 | 実行入口を `src/libra/app.py` に統一し、配布リソースを `src/libra/resources/` 配下へ集約 | 開発用ランチャーと本体入口の二重管理を避け、PyInstaller配布時のimport/同梱ブレを減らすため | エントリポイント/リソース配置/テストimport |
| 2026-02-10 | `core/`/`ui/` の配置方針を `src/libra/` 配下へ統一し、PyInstaller のビルド入口を `src/libra/app.py` 固定のスクリプトで明文化 | デバッグ配布時の同梱漏れとビルド再現性の揺れを避けるため | ディレクトリ構成/ビルド運用 |
| 2026-02-10 | PyInstaller 実行入口を `src/pyinstaller_entry.py` に分離し、配布zip名をプロダクト版（例: `Libra-0.1.0`）固定・`VERSION.txt` を `プロダクト版+ビルド識別子` へ変更 | 配布物名を利用者向けバージョンで安定化しつつ、`app.py` 直接実行で起きる相対import失敗を防ぎ、トラブル時の追跡性を維持するため | ビルド運用/起動安定性/配布物命名 |

---

## 11. バックログ（保留・次回）

| ID | 内容 | 優先度 | メモ |
| --- | --- | --- | --- |
| BL-001 | UI 文言の統一と命名ルール定義 | 中 | 画面とメタの整合確認 |
| BL-002 | 受入テスト項目の詳細化 | 中 | 自動化可否を検討 |
